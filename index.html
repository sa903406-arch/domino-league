<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¯ÙˆÙ…Ù†Ø© Ø§Ù„Ù…Ù„ÙƒÙŠ</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3c72;
            --secondary: #2a5298;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
            --bg: #f3f4f6;
            --white: #ffffff;
            --text: #1f2937;
            --danger: #ef4444;
            --success: #10b981;
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding-bottom: 80px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ */
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--white);
            padding: 25px 20px 40px;
            text-align: center;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 10px 25px rgba(30, 60, 114, 0.2);
            position: relative;
        }
        header h1 { margin: 0; font-size: 1.5rem; font-weight: 900; }
        header p { margin: 5px 0 0; opacity: 0.8; font-size: 0.9rem; }

        /* --- Ø§Ù„Ø­Ø§ÙˆÙŠØ§Øª ÙˆØ§Ù„ÙƒØ±ÙˆØª --- */
        .container { max-width: 600px; margin: -30px auto 0; padding: 0 15px; position: relative; z-index: 2; }
        
        .card {
            background: var(--white);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.02);
        }

        h3 { color: var(--primary); margin-top: 0; display: flex; align-items: center; gap: 8px; font-size: 1.1rem; }

        /* --- Ù…Ù†ØµØ© Ø§Ù„ØªØªÙˆÙŠØ¬ (Podium) --- */
        .podium-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            height: 240px;
            margin-bottom: 25px;
            gap: 15px;
        }
        .podium-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: transform 0.3s;
        }
        .podium-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid var(--white);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            object-fit: cover;
            margin-bottom: -15px; /* ØªØ¯Ø§Ø®Ù„ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø¹ Ø§Ù„Ø¹Ù…ÙˆØ¯ */
            z-index: 2;
            background: #eee;
        }
        .podium-rank {
            width: 80px;
            border-radius: 15px 15px 0 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: var(--white);
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .rank-1 .podium-rank { height: 140px; background: var(--gold); background: linear-gradient(to bottom, #FFD700, #FDB931); }
        .rank-2 .podium-rank { height: 100px; background: var(--silver); background: linear-gradient(to bottom, #E0E0E0, #BDBDBD); }
        .rank-3 .podium-rank { height: 80px; background: var(--bronze); background: linear-gradient(to bottom, #CD7F32, #A0522D); }
        
        .rank-1 .podium-avatar { width: 70px; height: 70px; border-color: var(--gold); }
        .player-name-podium { font-size: 0.8rem; margin-top: 5px; font-weight: bold; color: rgba(255,255,255,0.9); }
        .player-score-podium { font-size: 1.2rem; font-weight: 900; }

        /* --- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… --- */
        .player-row {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .player-row:last-child { border-bottom: none; }
        .rank-num { width: 30px; font-weight: 900; color: #ccc; text-align: center; }
        .rank-1-text { color: #DAA520; }
        .rank-2-text { color: #7f8c8d; }
        .rank-3-text { color: #A0522D; }
        
        .list-avatar {
            width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin: 0 10px; background: #eee;
        }
        .list-info { flex: 1; }
        .list-name { font-weight: bold; display: block; font-size: 0.95rem; }
        .list-stats { font-size: 0.75rem; color: #666; }
        .list-score {
            background: var(--bg); padding: 5px 10px; border-radius: 8px; font-weight: 900; min-width: 30px; text-align: center;
        }
        .score-pos { color: var(--success); background: #d1fae5; }
        .score-neg { color: var(--danger); background: #fee2e2; }

        /* --- Ø§Ù„ÙÙˆØ±Ù… ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        input, select {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 2px solid #e5e7eb; border-radius: 12px;
            font-family: 'Cairo'; outline: none; box-sizing: border-box; transition: 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary); }
        
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer;
            font-family: 'Cairo'; transition: transform 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        
        /* --- Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: white; 
            display: flex; justify-content: space-around; padding: 12px 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 100;
            border-radius: 20px 20px 0 0;
        }
        .nav-item {
            text-align: center; color: #9ca3af; cursor: pointer; transition: 0.3s;
        }
        .nav-item i { font-size: 1.4rem; display: block; margin-bottom: 2px; font-style: normal; }
        .nav-item span { font-size: 0.7rem; font-weight: bold; }
        .nav-item.active { color: var(--primary); transform: translateY(-5px); }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ù‚ÙÙ„ (Password Modal) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8);
            z-index: 200; display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; padding: 30px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ† Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¯ÙˆÙ…Ù†Ø© Ø§Ù„Ù…Ù„ÙƒÙŠ</h1>
    <p>ØªØ§Ø¨Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØ±ØªÙŠØ¨ Ù„Ø­Ø¸Ø© Ø¨Ù„Ø­Ø¸Ø©</p>
</header>

<div class="container">
    
    <div id="page-home">
        <div class="podium-container" id="podiumUI">
            <p style="margin:auto; color:#888;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„...</p>
        </div>

        <div class="card">
            <h3>ğŸ“Š ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
            <div id="leaderboardList"></div>
        </div>
    </div>

    <div id="page-admin" class="hidden">
        
        <div class="card" style="border-right: 4px solid var(--success);">
            <h3>ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯</h3>
            <input type="text" id="newPlayerName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨">
            <input type="url" id="newPlayerImg" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <button class="btn btn-success" onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø¯ÙŠÙˆØ§Ù†</button>
        </div>

        <div class="card" style="border-right: 4px solid var(--primary);">
            <h3>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø¬ÙˆÙ„Ø©</h3>
            <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
            <input type="date" id="gameDate">
            
            <label>Ø§Ù„Ù„Ø§Ø¹Ø¨</label>
            <select id="playerSelect"></select>
            
            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label>ÙÙˆØ² (+)</label>
                    <input type="number" id="winCount" placeholder="0">
                </div>
                <div style="flex:1">
                    <label>Ø®Ø³Ø§Ø±Ø© (-)</label>
                    <input type="number" id="lossCount" placeholder="0">
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="addRecord()">Ø­ÙØ¸ ÙˆØªØ­Ø¯ÙŠØ«</button>
        </div>

        <div class="card">
            <h3>ğŸ•’ Ø¢Ø®Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h3>
            <div id="adminHistoryList" style="font-size: 0.9rem;"></div>
        </div>
    </div>

</div>

<div id="loginModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>ğŸ”’ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
        <p>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <input type="password" id="adminPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
        <button class="btn btn-primary" onclick="checkPassword()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" style="margin-top:10px; color:var(--text)" onclick="closeLogin()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="showHome()">
        <i>ğŸ </i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
    </div>
    <div class="nav-item" onclick="requestAdmin()">
        <i>âš™ï¸</i><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
    </div>
</nav>

<script type="module">
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDJS8QCZRfa72Vl8NZxFZcLY-ee0CFILzw",
        authDomain: "koster-499c0.firebaseapp.com",
        projectId: "koster-499c0",
        storageBucket: "koster-499c0.firebasestorage.app",
        messagingSenderId: "170205849470",
        appId: "1:170205849470:web:7133888e3051c7ab47b52f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
    let playersData = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„ØµÙˆØ±
    let isAdminUnlocked = false;
    const ADMIN_PASS = "1234"; // <<<< ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡Ø§ Ù‡Ù†Ø§)

    // ØªØ¹ÙŠÙŠÙ† ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
    document.getElementById('gameDate').valueAsDate = new Date();

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø­Ù…Ø§ÙŠØ© ---
    window.showHome = () => {
        document.getElementById('page-home').classList.remove('hidden');
        document.getElementById('page-admin').classList.add('hidden');
        updateNavState(0);
    };

    window.requestAdmin = () => {
        if (isAdminUnlocked) {
            showAdmin();
        } else {
            document.getElementById('loginModal').classList.remove('hidden');
        }
    };

    window.checkPassword = () => {
        const input = document.getElementById('adminPassword').value;
        if (input === ADMIN_PASS) {
            isAdminUnlocked = true;
            document.getElementById('loginModal').classList.add('hidden');
            showAdmin();
        } else {
            alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©!");
        }
    };

    window.closeLogin = () => {
        document.getElementById('loginModal').classList.add('hidden');
    };

    function showAdmin() {
        document.getElementById('page-home').classList.add('hidden');
        document.getElementById('page-admin').classList.remove('hidden');
        updateNavState(1);
    }

    function updateNavState(index) {
        const items = document.querySelectorAll('.nav-item');
        items.forEach(i => i.classList.remove('active'));
        items[index].classList.add('active');
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---

    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„ØµÙˆØ±
    async function loadPlayers() {
        const q = query(collection(db, "players"));
        onSnapshot(q, (snap) => {
            const select = document.getElementById('playerSelect');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ø§Ù‹...</option>';
            playersData = {};

            snap.forEach(d => {
                const p = d.data();
                playersData[p.name] = p.imageUrl || "https://cdn-icons-png.flaticon.com/512/847/847969.png"; // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                select.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            });
            // Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŒ Ù†Ø¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±
            fetchRecords(); 
        });
    }

    // 2. Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ Ø¬Ø¯ÙŠØ¯
    window.addPlayer = async () => {
        const name = document.getElementById('newPlayerName').value.trim();
        const img = document.getElementById('newPlayerImg').value.trim();
        
        if(!name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");
        
        try {
            await addDoc(collection(db, "players"), { name: name, imageUrl: img });
            document.getElementById('newPlayerName').value = "";
            document.getElementById('newPlayerImg').value = "";
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
        } catch(e) { console.error(e); alert("Ø®Ø·Ø£"); }
    };

    // 3. Ø¥Ø¶Ø§ÙØ© Ù†ØªÙŠØ¬Ø© (Ø³Ø¬Ù„)
    window.addRecord = async () => {
        const name = document.getElementById('playerSelect').value;
        const date = document.getElementById('gameDate').value;
        const win = parseInt(document.getElementById('winCount').value) || 0;
        const loss = parseInt(document.getElementById('lossCount').value) || 0;

        if(!name) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù„Ø§Ø¹Ø¨");

        await addDoc(collection(db, "game_records"), {
            name, date, win, loss,
            diff: win - loss,
            total: win + loss,
            timestamp: new Date()
        });

        // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('winCount').value = "";
        document.getElementById('lossCount').value = "";
        alert("ØªÙ… Ø§Ù„Ø­ÙØ¸!");
    };

    // 4. Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ (Ù‚Ù„Ø¨ Ø§Ù„Ù†Ø¸Ø§Ù…)
    function fetchRecords() {
        const q = query(collection(db, "game_records"), orderBy("date", "desc"));
        
        onSnapshot(q, (snap) => {
            let stats = {};
            let historyHTML = "";

            snap.forEach(d => {
                const r = d.data();
                
                // ØªØ¹Ø¨Ø¦Ø© Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                historyHTML += `
                    <div class="player-row" style="justify-content:space-between; font-size:0.85rem">
                        <span>${r.date} | <b>${r.name}</b></span>
                        <span>
                            <span style="color:green">+${r.win}</span> / <span style="color:red">-${r.loss}</span>
                            <button onclick="delRecord('${d.id}')" style="background:none;border:none;cursor:pointer;margin-right:5px">âŒ</button>
                        </span>
                    </div>`;

                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                if (!stats[r.name]) {
                    stats[r.name] = { name: r.name, win: 0, loss: 0, diff: 0, total: 0 };
                }
                stats[r.name].win += r.win;
                stats[r.name].loss += r.loss;
                stats[r.name].diff += r.diff;
                stats[r.name].total += r.total;
            });

            document.getElementById('adminHistoryList').innerHTML = historyHTML;
            renderLeaderboard(stats);
        });
    }

    // 5. Ø±Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (Ø§Ù„Ù…Ù†ØµØ© ÙˆØ§Ù„ØªØ±ØªÙŠØ¨)
    function renderLeaderboard(stats) {
        // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒØ§Ø¦Ù† Ù„Ù…ØµÙÙˆÙØ© ÙˆØªØ±ØªÙŠØ¨Ù‡Ø§
        const sorted = Object.values(stats).sort((a, b) => b.diff - a.diff);
        
        const leaderboardDiv = document.getElementById('leaderboardList');
        const podiumDiv = document.getElementById('podiumUI');
        
        leaderboardDiv.innerHTML = "";
        podiumDiv.innerHTML = "";

        if (sorted.length === 0) {
            podiumDiv.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</p>";
            return;
        }

        // --- Ø±Ø³Ù… Ø§Ù„Ù…Ù†ØµØ© (Top 3) ---
        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØµØ©: Ø§Ù„Ø«Ø§Ù†ÙŠ (ÙŠØ³Ø§Ø±) - Ø§Ù„Ø£ÙˆÙ„ (ÙˆØ³Ø·) - Ø§Ù„Ø«Ø§Ù„Ø« (ÙŠÙ…ÙŠÙ†)
        const podiumOrder = [1, 0, 2]; 
        
        podiumOrder.forEach(idx => {
            if (sorted[idx]) {
                const p = sorted[idx];
                const rank = idx + 1;
                const img = playersData[p.name] || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
                
                podiumDiv.innerHTML += `
                    <div class="podium-item rank-${rank}">
                        <img src="${img}" class="podium-avatar">
                        <div class="podium-rank">
                            <span class="player-score-podium">${p.diff}</span>
                            <span class="player-name-podium">${p.name}</span>
                        </div>
                    </div>
                `;
            }
        });

        // --- Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ---
        sorted.forEach((p, index) => {
            const rank = index + 1;
            const img = playersData[p.name] || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            const diffClass = p.diff >= 0 ? "score-pos" : "score-neg";
            const rankClass = rank <= 3 ? `rank-${rank}-text` : "";

            leaderboardDiv.innerHTML += `
                <div class="player-row">
                    <div class="rank-num ${rankClass}">${rank}</div>
                    <img src="${img}" class="list-avatar">
                    <div class="list-info">
                        <span class="list-name">${p.name}</span>
                        <span class="list-stats">Ù„Ø¹Ø¨: ${p.total} | ÙØ§Ø²: ${p.win}</span>
                    </div>
                    <div class="list-score ${diffClass}">${p.diff}</div>
                </div>
            `;
        });
    }

    // Ø­Ø°Ù Ø³Ø¬Ù„
    window.delRecord = async (id) => {
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) await deleteDoc(doc(db, "game_records", id));
    };

    // Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
    loadPlayers();

</script>

</body>
</html>
