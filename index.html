<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¯ÙˆÙ…Ù†Ø© Ø§Ù„Ù…Ù„ÙƒÙŠ | Pro Stats</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3c72; 
            --secondary: #2a5298;
            --gold: #FFD700; 
            --silver: #C0C0C0; 
            --bronze: #CD7F32;
            --bg: #f3f4f6; 
            --white: #ffffff; 
            --text: #1f2937;
            --danger: #ef4444; 
            --success: #10b981; 
            --accent: #8e44ad;
        }

        body { 
            font-family: 'Cairo', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding-bottom: 90px; 
            user-select: none; /* Ù…Ù†Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Øµ Ù„ØªØ¬Ø±Ø¨Ø© ØªØ´Ø¨Ù‡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
            -webkit-tap-highlight-color: transparent;
        }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: var(--white); 
            padding: 20px 20px 45px; 
            text-align: center; 
            border-radius: 0 0 35px 35px; 
            box-shadow: 0 10px 30px rgba(30,60,114,0.25); 
        }
        header h1 { margin: 0; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* --- Ø§Ù„Ø­Ø§ÙˆÙŠØ© ÙˆØ§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª --- */
        .container { max-width: 600px; margin: -35px auto 0; padding: 0 15px; position: relative; z-index: 2; }
        
        .card { 
            background: var(--white); 
            border-radius: 24px; 
            padding: 20px; 
            margin-bottom: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            border: 1px solid rgba(255,255,255,0.8);
        }
        
        h3 { 
            color: var(--primary); 
            margin-top: 0; 
            display: flex; align-items: center; gap: 8px; 
            font-size: 1.1rem; 
            border-bottom: 2px solid #f1f5f9; 
            padding-bottom: 12px; 
        }

        /* --- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (MODAL) --- */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(8px); /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø²Ø¬Ø§Ø¬ */
            z-index: 1000; 
            display: flex; justify-content: center; align-items: center; 
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }

        .modal-box { 
            background: white; 
            padding: 25px; 
            border-radius: 30px; 
            width: 85%; max-width: 350px; 
            text-align: center; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); 
            transform: translateY(20px); transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh; overflow-y: auto;
        }
        .modal-overlay.active .modal-box { transform: translateY(0); }

        /* Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø¯Ø§Ø¡ (Form Dots) */
        .form-dot {
            width: 28px; height: 28px; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 0.75rem; font-weight: bold; color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* --- Ø§Ù„Ø£ÙˆØ³Ù…Ø© (Badges) --- */
        .badge-item { 
            display: flex; align-items: center; gap: 15px; 
            padding: 15px; border-radius: 18px; 
            background: #fff; 
            margin-bottom: 12px; 
            border: 1px solid #e2e8f0; 
            transition: 0.2s;
            cursor: pointer; /* Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø¶ØºØ· */
            position: relative; overflow: hidden;
        }
        .badge-item:active { transform: scale(0.98); background: #f8fafc; }
        .badge-item::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; background: var(--gold);
        }
        .badge-icon { font-size: 2.2rem; min-width: 50px; text-align: center; }
        .badge-img { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 3px solid #f1f5f9; }
        .badge-info { flex: 1; }
        .badge-title { font-weight: 900; color: var(--primary); font-size: 0.95rem; display: block; margin-bottom: 2px; }
        .badge-name { font-weight: 600; font-size: 0.9rem; color: #64748b; }
        .badge-value { font-size: 0.75rem; background: var(--primary); color: white; padding: 3px 10px; border-radius: 20px; margin-top: 5px; display: inline-block; }

        /* --- Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ù…Ù†ØµØ© --- */
        .podium-container { display: flex; justify-content: center; align-items: flex-end; height: 210px; margin-bottom: 25px; gap: 8px; }
        .podium-item { display: flex; flex-direction: column; align-items: center; width: 32%; cursor: pointer; transition: 0.2s; }
        .podium-item:active { transform: scale(0.95); }
        .podium-avatar { width: 50px; height: 50px; border-radius: 50%; border: 3px solid var(--white); box-shadow: 0 4px 10px rgba(0,0,0,0.15); margin-bottom: -15px; z-index: 2; background: #eee; object-fit: cover; }
        .podium-rank { width: 100%; border-radius: 15px 15px 10px 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; color: var(--white); font-weight: bold; padding: 10px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .rank-1 .podium-rank { height: 120px; background: linear-gradient(180deg, #FFD700 0%, #FDB931 100%); }
        .rank-2 .podium-rank { height: 90px; background: linear-gradient(180deg, #E0E0E0 0%, #BDBDBD 100%); }
        .rank-3 .podium-rank { height: 70px; background: linear-gradient(180deg, #CD7F32 0%, #A0522D 100%); }

        .player-row { display: flex; align-items: center; padding: 14px 0; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .player-row:active { background-color: #f8fafc; }
        .player-row:last-child { border-bottom: none; }
        .list-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; margin: 0 12px; background: #eee; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .list-score { padding: 6px 12px; border-radius: 10px; font-weight: 800; min-width: 35px; text-align: center; font-size: 0.9rem; }
        .score-pos { color: #065f46; background: #d1fae5; }
        .score-neg { color: #991b1b; background: #fee2e2; }

        /* --- Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø³ÙÙ„ÙŠ --- */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; 
            padding: 12px 0 20px; 
            box-shadow: 0 -10px 30px rgba(0,0,0,0.05); 
            z-index: 100; border-radius: 25px 25px 0 0; border-top: 1px solid rgba(255,255,255,0.5);
        }
        .nav-item { text-align: center; color: #94a3b8; cursor: pointer; flex: 1; transition: 0.3s; position: relative; }
        .nav-item i { font-style: normal; font-size: 1.4rem; display: block; margin-bottom: 2px; transition: 0.3s; }
        .nav-item span { font-size: 0.7rem; font-weight: 700; display: block; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: translateY(-5px); }

        /* --- Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± --- */
        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 2px solid #e2e8f0; border-radius: 14px; font-family: 'Cairo'; box-sizing: border-box; font-size: 0.95rem; outline: none; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 14px; font-weight: 700; cursor: pointer; font-family: 'Cairo'; font-size: 1rem; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(30,60,114,0.3); }
        .btn-success { background: var(--success); color: white; box-shadow: 0 4px 15px rgba(16,185,129,0.3); }
        
        /* Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© */
        .hidden { display: none !important; }
        .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.95rem; }
        .date-header { background: #f8fafc; padding: 8px 15px; font-weight: bold; font-size: 0.8rem; border-radius: 8px; margin: 20px 0 10px; color: #64748b; letter-spacing: 0.5px; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ† Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¯ÙˆÙ…Ù†Ø© Ø§Ù„Ù…Ù„ÙƒÙŠ</h1>
    <p style="margin:5px 0 0; opacity:0.8; font-size:0.85rem;">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</p>
</header>

<div class="container">

    <div id="profileModal" class="modal-overlay" onclick="closeProfile()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div id="profileContent">
                </div>
            <button class="btn" style="margin-top:20px; background:#f1f5f9; color:#333;" onclick="closeProfile()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div id="page-home">
        <div class="podium-container" id="podiumUI"></div>
        <div class="card">
            <h3>ğŸ“Š Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù…</h3>
            <div id="leaderboardList"></div>
        </div>
    </div>

    <div id="page-stats" class="hidden">
        <div class="card">
            <h3>ğŸ… Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø±Ù</h3>
            <p style="font-size:0.8rem; color:#666; margin-bottom:15px;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠ ÙˆØ³Ø§Ù… Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
            <div id="badgesContainer">
                <p style="text-align:center; color:#888;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
            </div>
        </div>
    </div>

    <div id="page-history" class="hidden">
        <div class="card">
            <h3>ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª</h3>
            <div id="historyByDateList"></div>
        </div>
    </div>

    <div id="page-teams" class="hidden">
        <div class="card" style="border-right: 5px solid var(--accent);">
            <h3>ğŸ² Ù‚Ø±Ø¹Ø© Ø¹Ø§Ø¯Ù„Ø©</h3>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 10px;">Ø­Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ†:</p>
            
            <div id="firebasePlayersSelection" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; max-height: 250px; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 12px; margin-bottom: 15px; background: #fafafa;">
                <p style="grid-column: 1/-1; text-align: center; color: #999;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†...</p>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <small id="selectedCount" style="font-weight: bold; color: var(--primary);">Ø§Ù„Ù…Ø®ØªØ§Ø±ÙŠÙ†: 0</small>
                <button onclick="clearSelection()" style="background:none; border:none; color:var(--danger); cursor:pointer; font-size:0.8rem; font-family:'Cairo'">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒÙ„</button>
            </div>
            
            <button class="btn btn-primary" id="drawBtn" onclick="runTeamDraw()" style="background:var(--accent)">ØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙØ±Ù‚ ğŸ”¥</button>
            
            <div id="drawLoader" class="hidden" style="text-align:center; margin: 20px 0;">
                <p>ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø®Ù„Ø· Ø§Ù„Ø£ÙˆØ±Ø§Ù‚...</p>
            </div>

            <div id="teamsResults" style="margin-top:20px;"></div>
        </div>
    </div>

    <div id="page-admin" class="hidden">
        <div style="text-align: left; margin-bottom: 15px;">
            <button onclick="logout()" style="background:var(--danger); color:white; border:none; padding:8px 15px; border-radius:10px; cursor:pointer;">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ğŸ”’</button>
        </div>
        
        <div class="card" style="border-right: 5px solid var(--primary);">
            <h3>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <input type="date" id="gameDate">
            <select id="playerSelect"></select>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="winCount" placeholder="ÙÙˆØ² (+)" style="border-color:var(--success)">
                <input type="number" id="lossCount" placeholder="Ø®Ø³Ø§Ø±Ø© (-)" style="border-color:var(--danger)">
            </div>
            <button class="btn btn-primary" onclick="addRecord()">Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
        </div>

        <div class="card" style="border-right: 5px solid var(--success);">
            <h3>ğŸ‘¤ Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</h3>
            <input type="text" id="newPlayerName" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <input type="url" id="newPlayerImg" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            <button class="btn btn-success" onclick="addPlayer()">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
        </div>
        
        <div class="card" style="border-right: 5px solid var(--danger);">
            <h3>âš ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚Ø±Ø¹Ø©</h3>
            <p style="font-size:0.75rem; color:#666;">Ø§Ù…Ø³Ø­ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨ØªÙƒØ±Ø§Ø± Ø§Ù„ÙØ±Ù‚ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
            <button class="btn" style="background:var(--danger); color:white;" onclick="resetMatchups()">ØªØµÙÙŠØ± Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª</button>
        </div>

        <div class="card">
            <h3>ğŸ—‘ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h3>
            <div id="adminPlayersList"></div>
        </div>
    </div>
</div>

<div id="loginModal" class="modal-overlay">
    <div class="modal-box">
        <h3>ğŸ”’ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</h3>
        <p style="color:#666; font-size:0.9rem;">Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
        <input type="password" id="adminPassword" placeholder="â€¢â€¢â€¢â€¢" style="text-align:center; letter-spacing:5px;">
        <button class="btn btn-primary" onclick="checkPassword()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn" style="margin-top:10px; background:white; color:#666" onclick="closeLogin()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('page-home', this)"><i>ğŸ </i><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></div>
    <div class="nav-item" onclick="switchTab('page-stats', this)"><i>ğŸ…</i><span>Ø§Ù„Ø£ÙˆØ³Ù…Ø©</span></div>
    <div class="nav-item" onclick="switchTab('page-teams', this)"><i>ğŸ²</i><span>Ø§Ù„Ù‚Ø±Ø¹Ø©</span></div>
    <div class="nav-item" onclick="switchTab('page-history', this)"><i>ğŸ“…</i><span>Ø§Ù„Ø£Ø±Ø´ÙŠÙ</span></div>
    <div class="nav-item" onclick="requestAdmin(this)"><i>âš™ï¸</i><span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span></div>
</nav>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙØ§ÙŠØ±Ø¨ÙŠØ³
    const firebaseConfig = {
        apiKey: "AIzaSyDJS8QCZRfa72Vl8NZxFZcLY-ee0CFILzw",
        authDomain: "koster-499c0.firebaseapp.com",
        projectId: "koster-499c0",
        storageBucket: "koster-499c0.firebasestorage.app",
        messagingSenderId: "170205849470",
        appId: "1:170205849470:web:7133888e3051c7ab47b52f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
    let playersData = {}; 
    let isAdminUnlocked = false;
    const ADMIN_PASS = "1234";
    let cachedStats = {}; 
    let cachedHistory = {};
    let selectedForDraw = [];

    // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ÙŠÙˆÙ…
    document.getElementById('gameDate').valueAsDate = new Date();

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ø¹Ø±Ø¶ ---
    window.switchTab = (pageId, elem) => {
        document.querySelectorAll('.container > div[id^="page-"]').forEach(d => d.classList.add('hidden'));
        document.getElementById(pageId).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        if(elem) elem.classList.add('active');
        if (pageId === 'page-teams') updateSelectionList();
        window.scrollTo(0,0);
    };

    window.requestAdmin = (elem) => { 
        if(isAdminUnlocked) {
            window.switchTab('page-admin', elem);
        } else {
            document.getElementById('loginModal').classList.add('active');
        }
    };

    window.checkPassword = () => {
        if (document.getElementById('adminPassword').value === ADMIN_PASS) {
            isAdminUnlocked = true;
            document.getElementById('loginModal').classList.remove('active');
            window.switchTab('page-admin', document.querySelectorAll('.nav-item')[4]);
            renderHistory(cachedHistory); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù„ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø­Ø°Ù
        } else { 
            alert("Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦!"); 
        }
    };

    window.logout = () => { 
        isAdminUnlocked = false; 
        document.getElementById('adminPassword').value = "";
        renderHistory(cachedHistory); 
        window.switchTab('page-home', document.querySelectorAll('.nav-item')[0]); 
    };

    window.closeLogin = () => document.getElementById('loginModal').classList.remove('active');

    // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ Ø§Ù„Ù…Ø·ÙˆØ± ---
  // --- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ (Ù†Ø³Ø®Ø© Ø¨Ø·Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹) ---
    window.showProfile = (playerName) => {
        const p = cachedStats[playerName];
        if (!p) return;

        // 1. Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª ØªØµØ¯Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Weekly Champion)
        let weeklyTitles = 0; // Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª Ø§Ù„ØªÙŠ ÙƒØ§Ù† ÙÙŠÙ‡Ø§ Ø§Ù„Ø£ÙˆÙ„
        let participatedWeeks = 0; // Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„ØªÙŠ Ø­Ø¶Ø±Ù‡Ø§

        // Ù†Ù…Ø± Ø¹Ù„Ù‰ ÙƒÙ„ ØªØ§Ø±ÙŠØ® (ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹) ÙÙŠ Ø§Ù„Ø³Ø¬Ù„
        Object.keys(cachedHistory).forEach(date => {
            const daysMatches = cachedHistory[date];
            
            // Ø­Ø³Ø§Ø¨ Ù…Ø¬Ù…ÙˆØ¹ Ù†Ù‚Ø§Ø· ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®
            let dayScores = {};
            let playedThisWeek = false;

            daysMatches.forEach(m => {
                if (!dayScores[m.name]) dayScores[m.name] = 0;
                dayScores[m.name] += m.diff; // Ù†Ø¬Ù…Ø¹ Ø§Ù„ÙØ§Ø±Ù‚ (Ø§Ù„Ù†Ù‚Ø§Ø·)
                if (m.name === playerName) playedThisWeek = true;
            });

            if (playedThisWeek) {
                participatedWeeks++;
                
                // Ù…Ø¹Ø±ÙØ© Ù…Ù† Ù‡Ùˆ ØµØ§Ø­Ø¨ Ø£Ø¹Ù„Ù‰ Ø±ØµÙŠØ¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®
                let maxScore = -9999;
                let topPlayer = "";
                
                Object.entries(dayScores).forEach(([name, score]) => {
                    if (score > maxScore) {
                        maxScore = score;
                        topPlayer = name;
                    }
                });

                // Ù‡Ù„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ùˆ Ø§Ù„Ù…ØªØµØ¯Ø± Ù„Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ
                if (topPlayer === playerName) {
                    weeklyTitles++;
                }
            }
        });

        // 2. ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¯Ø§Ø¡ (Ø¢Ø®Ø± 5 Ù…Ø¨Ø§Ø±ÙŠØ§Øª)
        let allMatches = [];
        Object.keys(cachedHistory).forEach(date => {
            cachedHistory[date].forEach(match => {
                if (match.name === playerName) {
                    allMatches.push({ ...match, date });
                }
            });
        });
        
        // ØªØ±ØªÙŠØ¨ Ø²Ù…Ù†ÙŠ
        allMatches.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        let last5 = [];
        let bestWin = 0;

        allMatches.forEach(m => {
            last5.push(m.diff > 0 ? 'W' : 'L');
            if (m.win > bestWin) bestWin = m.win;
        });

        const recentForm = last5.slice(-5).reverse();
        const winRate = p.total > 0 ? ((p.win / p.total) * 100).toFixed(1) : 0;
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¹Ø§Ù…
        const allPlayers = Object.values(cachedStats).sort((a,b) => b.diff - a.diff);
        const rank = allPlayers.findIndex(player => player.name === playerName) + 1;

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        const content = document.getElementById('profileContent');
        content.innerHTML = `
            <div style="position:relative; margin-bottom:15px; display:inline-block;">
                <img src="${playersData[playerName]}" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:4px solid var(--primary); box-shadow:0 4px 15px rgba(0,0,0,0.1);">
                <div style="position:absolute; bottom:5px; right:5px; background:var(--gold); color:black; width:30px; height:30px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:900; border:2px solid white; font-size:0.9rem;">${rank}</div>
            </div>
            
            <h2 style="margin:0; color:var(--primary); font-size:1.5rem;">${playerName}</h2>
            <p style="font-size:0.75rem; color:#888; margin-bottom:15px;">Ø­Ø¶Ø± ${participatedWeeks} ØªØ¬Ù…Ø¹/Ø£Ø³Ø¨ÙˆØ¹</p>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:20px;">
                <div style="background:#f0fdf4; padding:10px; border-radius:15px; border:1px solid #dcfce7;">
                    <small style="color:#15803d; display:block; font-weight:bold;">ğŸ† Ø¨Ø·Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</small>
                    <b style="font-size:1.4rem; color:#15803d;">${weeklyTitles} <span style="font-size:0.8rem;">Ù…Ø±Ø§Øª</span></b>
                </div>
                <div style="background:#f8fafc; padding:10px; border-radius:15px; border:1px solid #edf2f7;">
                    <small style="color:#64748b; display:block;">Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²</small>
                    <b style="font-size:1.2rem; color:var(--accent);">${winRate}%</b>
                </div>
            </div>

            <div style="text-align:right; margin-bottom:15px;">
                <small style="color:#64748b; margin-bottom:8px; display:block;">ÙÙˆØ±Ù…Ø© Ø¢Ø®Ø± 5 Ù…Ø¨Ø§Ø±ÙŠØ§Øª:</small>
                <div style="display:flex; gap:6px; justify-content:center; flex-direction:row-reverse;">
                    ${recentForm.length > 0 ? recentForm.map(res => `
                        <div class="form-dot" style="background:${res==='W'?'#10b981':'#ef4444'}">${res}</div>
                    `).join('') : '<span style="color:#ccc;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</span>'}
                </div>
            </div>

            <div style="background:#f1f5f9; border-radius:15px; padding:15px; text-align:right; font-size:0.9rem;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ²:</span>
                    <span style="font-weight:bold; color:#059669;">${p.win}</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                    <span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø³Ø§Ø±Ø©:</span>
                    <span style="font-weight:bold; color:#ef4444;">${p.loss}</span>
                </div>
                <div style="display:flex; justify-content:space-between; border-top:1px solid #cbd5e1; padding-top:8px; margin-top:8px;">
                    <span>Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© (Game):</span>
                    <span style="font-weight:bold; color:var(--primary);">${bestWin}</span>
                </div>
            </div>
        `;

        document.getElementById('profileModal').classList.add('active');
    };

        document.getElementById('profileModal').classList.add('active');
    };

    window.closeProfile = () => {
        document.getElementById('profileModal').classList.remove('active');
    };

    // --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (CRUD) ---
    window.addPlayer = async () => {
        const name = document.getElementById('newPlayerName').value.trim();
        const img = document.getElementById('newPlayerImg').value.trim();
        if(!name) return;
        const snap = await getDocs(query(collection(db, "players"), where("name", "==", name)));
        if(!snap.empty) return alert("Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!");
        
        await addDoc(collection(db, "players"), { 
            name, 
            imageUrl: img || "https://cdn-icons-png.flaticon.com/512/847/847969.png" 
        });
        document.getElementById('newPlayerName').value = '';
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­");
    };

    window.addRecord = async () => {
        const name = document.getElementById('playerSelect').value;
        const date = document.getElementById('gameDate').value;
        const win = parseInt(document.getElementById('winCount').value) || 0;
        const loss = parseInt(document.getElementById('lossCount').value) || 0;
        
        if(!name || !date) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        await addDoc(collection(db, "game_records"), { 
            name, date, win, loss, 
            diff: win - loss, 
            total: win + loss 
        });
        
        document.getElementById('winCount').value = '';
        document.getElementById('lossCount').value = '';
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©");
    };

    // --- Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­ÙŠØ© (Realtime Listeners) ---
    // 1. Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
    onSnapshot(collection(db, "players"), (snap) => {
        const select = document.getElementById('playerSelect');
        const adminList = document.getElementById('adminPlayersList');
        
        select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨Ø§Ù‹...</option>';
        adminList.innerHTML = "";
        playersData = {};
        
        snap.forEach(d => {
            const p = d.data();
            const imgUrl = p.imageUrl || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
            playersData[p.name] = imgUrl;
            
            select.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            
            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
            adminList.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; border-bottom:1px solid #eee">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <img src="${imgUrl}" style="width:30px; height:30px; border-radius:50%">
                        <span>${p.name}</span>
                    </div>
                    <button class="btn" style="width:auto; padding:5px 12px; font-size:0.8rem; background:#fee2e2; color:#ef4444;" onclick="deleteFullPlayer('${d.id}', '${p.name}')">Ø­Ø°Ù</button>
                </div>`;
        });
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±
        fetchRecords();
    });

    // 2. Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    function fetchRecords() {
        onSnapshot(query(collection(db, "game_records"), orderBy("date", "desc")), (snap) => {
            let stats = {}; 
            let history = {};
            
            snap.forEach(d => {
                const r = d.data();
                
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                if (!stats[r.name]) stats[r.name] = { name: r.name, win: 0, loss: 0, diff: 0, total: 0 };
                stats[r.name].win += r.win;
                stats[r.name].loss += r.loss;
                stats[r.name].diff += r.diff;
                stats[r.name].total += r.total;
                
                // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØªØ§Ø±ÙŠØ®
                if (!history[r.date]) history[r.date] = [];
                history[r.date].push({ ...r, id: d.id });
            });
            
            cachedStats = stats; 
            cachedHistory = history;
            
            renderHome(stats);
            renderHistory(history);
            renderBadges(stats);
        });
    }

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³Ù… (Rendering) ---
    function renderHome(stats) {
        const sorted = Object.values(stats).sort((a,b) => b.diff - a.diff);
        const podium = document.getElementById('podiumUI');
        const list = document.getElementById('leaderboardList');
        
        podium.innerHTML = ""; 
        list.innerHTML = "";

        // Ø±Ø³Ù… Ø§Ù„Ù…Ù†ØµØ© (3 Ø£ÙˆØ§Ø¦Ù„)
        [1, 0, 2].forEach(idx => {
            if(sorted[idx]) {
                const p = sorted[idx];
                podium.innerHTML += `
                    <div class="podium-item rank-${idx+1}" onclick="showProfile('${p.name}')">
                        <img src="${playersData[p.name]}" class="podium-avatar">
                        <div class="podium-rank">
                            <span style="font-size:1.2rem">${p.diff}</span>
                            <small>${p.name}</small>
                        </div>
                    </div>`;
            }
        });

        // Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        sorted.forEach((p, i) => {
            list.innerHTML += `
                <div class="player-row" onclick="showProfile('${p.name}')">
                    <div style="width:25px; font-weight:bold; color:#cbd5e1; text-align:center;">${i+1}</div>
                    <img src="${playersData[p.name]}" class="list-avatar">
                    <div style="flex:1">
                        <b style="font-size:0.95rem;">${p.name}</b>
                        <div style="font-size:0.7rem; color:#64748b;">Ù„Ø¹Ø¨: ${p.total} | ÙØ§Ø²: ${p.win}</div>
                    </div>
                    <div class="list-score ${p.diff>=0?'score-pos':'score-neg'}">${p.diff > 0 ? '+'+p.diff : p.diff}</div>
                </div>`;
        });
    }

    function renderBadges(stats) {
        const players = Object.values(stats);
        const container = document.getElementById('badgesContainer');
        container.innerHTML = "";
        
        if(players.length === 0) {
            container.innerHTML = "<p style='text-align:center'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</p>";
            return;
        }

        const king = [...players].sort((a,b) => b.diff - a.diff)[0];
        const warrior = [...players].sort((a,b) => b.total - a.total)[0];
        const unlucky = [...players].sort((a,b) => b.loss - a.loss)[0];
        const rock = [...players].filter(p => p.total >= 3).sort((a,b) => a.loss - b.loss)[0]; // Ø£Ù‚Ù„ Ø®Ø³Ø§Ø±Ø© (Ø¨Ø´Ø±Ø· Ù„Ø¹Ø¨ 3 Ù…Ø¨Ø§Ø±ÙŠØ§Øª)

        const createBadge = (icon, title, p, val, label) => `
            <div class="badge-item" onclick="showProfile('${p.name}')">
                <div class="badge-icon">${icon}</div>
                <img src="${playersData[p.name]}" class="badge-img">
                <div class="badge-info">
                    <span class="badge-title">${title}</span>
                    <span class="badge-name">${p.name}</span><br>
                    <span class="badge-value">${val} ${label}</span>
                </div>
            </div>`;

        if(king) container.innerHTML += createBadge("ğŸ‘‘", "Ù…Ù„Ùƒ Ø§Ù„Ø¯ÙˆÙ…Ù†Ø© (Ø§Ù„Ù…ØªØµØ¯Ø±)", king, king.diff, "Ù†Ù‚Ø·Ø©");
        if(warrior) container.innerHTML += createBadge("âš”ï¸", "Ø§Ù„Ù…Ø­Ø§Ø±Ø¨ (Ø§Ù„Ø£ÙƒØ«Ø± Ù„Ø¹Ø¨Ø§Ù‹)", warrior, warrior.total, "Ù…Ø¨Ø§Ø±Ø§Ø©");
        if(unlucky) container.innerHTML += createBadge("ğŸ§¨", "Ø§Ù„Ù…Ù†Ø­ÙˆØ³ (Ø§Ù„Ø£ÙƒØ«Ø± Ø®Ø³Ø§Ø±Ø©)", unlucky, unlucky.loss, "Ø®Ø³Ø§Ø±Ø©");
        if(rock) container.innerHTML += createBadge("ğŸ›¡ï¸", "Ø§Ù„Ø¬Ø¨Ù„ (Ø§Ù„Ø£Ù‚Ù„ Ø®Ø³Ø§Ø±Ø©)", rock, rock.loss, "Ø®Ø³Ø§Ø±Ø©");
    }

    function renderHistory(history) {
        const container = document.getElementById('historyByDateList');
        container.innerHTML = "";
        
        Object.keys(history).sort().reverse().forEach(date => {
            container.innerHTML += `<div class="date-header">ğŸ“… ${date}</div>`;
            history[date].forEach(r => {
                const deleteBtn = isAdminUnlocked ? 
                    `<span onclick="deleteRecord('${r.id}')" style="color:#ef4444; margin-left:10px; cursor:pointer;">âœ•</span>` : '';
                
                container.innerHTML += `
                    <div class="history-item">
                        <span>${deleteBtn} <b>${r.name}</b></span>
                        <span>
                            <span style="color:#10b981; font-weight:bold;">+${r.win}</span> 
                            <span style="color:#ef4444; font-weight:bold; margin-right:5px;">-${r.loss}</span>
                        </span>
                    </div>`;
            });
        });
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø­Ø°Ù ---
    window.deleteRecord = async (id) => { 
        if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) await deleteDoc(doc(db, "game_records", id)); 
    };
    
    window.deleteFullPlayer = async (id, name) => {
        if(confirm(`ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ ${name} ÙˆØ¬Ù…ÙŠØ¹ Ù†ØªØ§Ø¦Ø¬Ù‡ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©!\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ`)) {
            // Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨
            await deleteDoc(doc(db, "players", id));
            
            // Ø­Ø°Ù Ø³Ø¬Ù„Ø§ØªÙ‡
            const snap = await getDocs(query(collection(db, "game_records"), where("name", "==", name)));
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
            alert("ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
        }
    };

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø±Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ ---
    window.updateSelectionList = () => {
        const container = document.getElementById('firebasePlayersSelection');
        if (!container) return;
        container.innerHTML = "";
        
        Object.keys(playersData).sort().forEach(name => {
            const isChecked = selectedForDraw.includes(name);
            const div = document.createElement('div');
            div.style = `display:flex; align-items:center; gap:8px; background:${isChecked?'var(--primary)':'white'}; color:${isChecked?'white':'var(--text)'}; padding:8px 12px; border-radius:12px; cursor:pointer; border:1px solid #e2e8f0; transition:0.2s`;
            div.onclick = () => {
                const idx = selectedForDraw.indexOf(name);
                if (idx > -1) selectedForDraw.splice(idx, 1); else selectedForDraw.push(name);
                updateSelectionList();
            };
            div.innerHTML = `<img src="${playersData[name]}" style="width:25px; height:25px; border-radius:50%; object-fit:cover;"> <span style="font-size:0.85rem; font-weight:bold;">${name}</span>`;
            container.appendChild(div);
        });
        document.getElementById('selectedCount').innerText = `Ø§Ù„Ù…Ø®ØªØ§Ø±ÙŠÙ†: ${selectedForDraw.length}`;
    };

    window.clearSelection = () => { selectedForDraw = []; updateSelectionList(); };

    window.runTeamDraw = async () => {
        if (selectedForDraw.length < 2) return alert("Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ø«Ù†ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");
        
        const loader = document.getElementById('drawLoader');
        const results = document.getElementById('teamsResults');
        const btn = document.getElementById('drawBtn');

        results.innerHTML = "";
        loader.classList.remove('hidden');
        btn.disabled = true;

        try {
            const pastSnap = await getDocs(collection(db, "past_matchups"));
            let pastMatchups = [];
            pastSnap.forEach(d => pastMatchups.push(d.data().pair));

            let shuffled;
            let attempts = 0;
            let foundNewMatchup = false;
            let currentPairs = [];

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ ØªØ´ÙƒÙŠÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 15 Ù…Ø­Ø§ÙˆÙ„Ø©)
            while (attempts < 15 && !foundNewMatchup) {
                shuffled = [...selectedForDraw].sort(() => Math.random() - 0.5);
                currentPairs = [];
                let isRepeated = false;

                for (let i = 0; i < shuffled.length; i += 2) {
                    if (shuffled[i+1]) {
                        // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø£Ø¨Ø¬Ø¯ÙŠØ§Ù‹ Ù„Ù„ØªØ®Ø²ÙŠÙ†
                        let pair = [shuffled[i], shuffled[i+1]].sort().join("_vs_");
                        if (pastMatchups.includes(pair)) {
                            isRepeated = true;
                            break;
                        }
                        currentPairs.push(pair);
                    }
                }

                if (!isRepeated) foundNewMatchup = true;
                attempts++;
            }

            // Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            if (currentPairs.length > 0) {
                const batch = writeBatch(db);
                currentPairs.forEach(pair => {
                    const newRef = doc(collection(db, "past_matchups"));
                    batch.set(newRef, { pair: pair, timestamp: Date.now() });
                });
                await batch.commit();
            }

            loader.classList.add('hidden');
            btn.disabled = false;

            let html = `<h4 style="text-align:center; color:var(--accent); margin-bottom:15px;">Ø§Ù„ÙØ±Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ğŸ²</h4>`;
            if (attempts >= 15) html += `<p style="text-align:center; font-size:0.7rem; color:red; margin-top:-10px;">(Ù…Ù„Ø§Ø­Ø¸Ø©: ØªÙ… ØªÙƒØ±Ø§Ø± Ø¨Ø¹Ø¶ Ø§Ù„ÙØ±Ù‚)</p>`;
            
            for (let i = 0; i < shuffled.length; i += 2) {
                let p1 = shuffled[i], p2 = shuffled[i+1];
                html += `
                    <div class="badge-item" style="justify-content:space-between; background:white; border-right:5px solid var(--accent); margin-bottom:10px; padding:10px 15px; cursor:default;">
                        <div style="text-align:center; width:40%;">
                            <img src="${playersData[p1]}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; margin-bottom:5px;">
                            <div style="font-size:0.8rem; font-weight:bold;">${p1}</div>
                        </div>
                        <div style="font-weight:900; color:#cbd5e1; font-size:1.2rem;">VS</div>
                        <div style="text-align:center; width:40%;">
                            ${p2 ? `
                                <img src="${playersData[p2]}" style="width:40px; height:40px; border-radius:50%; object-fit:cover; margin-bottom:5px;">
                                <div style="font-size:0.8rem; font-weight:bold;">${p2}</div>
                            ` : '<div style="color:#999; font-size:0.8rem; line-height:40px;">Ø§Ù†ØªØ¸Ø§Ø±</div>'}
                        </div>
                    </div>`;
            }
            results.innerHTML = html;
            results.scrollIntoView({ behavior: 'smooth' });

        } catch (error) {
            console.error(error);
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
            loader.classList.add('hidden');
            btn.disabled = false;
        }
    };

    window.resetMatchups = async () => {
        if (!isAdminUnlocked) return;
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù‚Ø±Ø¹Ø© ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ø¨ØªÙƒØ±Ø§Ø± Ø§Ù„ÙØ±Ù‚.")) {
            const snap = await getDocs(collection(db, "past_matchups"));
            const batch = writeBatch(db);
            snap.forEach(d => batch.delete(d.ref));
            await batch.commit();
            alert("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø°Ø§ÙƒØ±Ø©!");
        }
    };
</script>
</body>
</html>
